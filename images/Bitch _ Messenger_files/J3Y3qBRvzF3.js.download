;/*FB_PKG_DELIM*/

__d("BootloaderErrorsFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5080"),s=o("FalcoLoggerInternal").create("bootloader_errors",e),u=s;l.default=u}),98);
__d("BootloaderEventsPerf",["invariant","Bootloader","BootloaderEvents","ResourceTimingStore","objectEntries","objectValues"],(function(t,n,r,o,a,i,l,s){var e=["durations","resources","start_time"],u={total_count:0,total_bytes:0,downloaded_count:0,downloaded_bytes:0,cached_count:0,cached_bytes:0,inlined_count:0,inlined_bytes:0,duration:0,missing_count:0};function c(e,t,n){return Math.max(0,(n!=null?n:0)-Math.max(e,t!=null?t:0))}function d(){return{blocking:babelHelpers.extends({},u),nonblocking:babelHelpers.extends({},u),default:babelHelpers.extends({},u)}}function m(e,t,n){var r,a;if(n==null)r=0,a="downloaded";else if(n[1])r=n[0].length,a="inlined";else{var i=o("ResourceTimingStore").getEntryForURL(n[0]);i?(r=i.encodedBodySize,a=i.transferSize===0?"cached":"downloaded"):(r=0,a="downloaded",e.missing_count++)}if(e.total_count++,e.total_bytes+=r,!!t)switch(e.duration=Math.max(e.duration,t),a){case"downloaded":e.downloaded_count++,e.downloaded_bytes+=r;break;case"inlined":e.inlined_count++,e.inlined_bytes+=r;break;case"cached":e.cached_count++,e.cached_bytes+=r;break}}function p(e,t,n,o,a){var i=r("Bootloader").getResourceState(t);m(e,c(n,i.loadStart,i.loadEnd),o),i.loadError!=null&&a.add(t)}function _(e,t,n,o){var a=d();for(var i of r("objectEntries")(e)){var l=i[0],u=i[1];for(var c of u){var m=c[0],_=c[1],f=void 0,g=void 0;switch(_.type){case"async":g=null,f=n;break;case"js":case"css":g=[_.src,_.d===1],f=a;break;default:s(0,3721)}p(f[l],m,t,g,o)}}return a}function f(e,t){var n={unpredicted:o("BootloaderEvents").newResourceMapSet(),ef:o("BootloaderEvents").newResourceMapSet(),overpredicted:o("BootloaderEvents").newResourceMapSet()};for(var a of r("objectEntries")(t)){var i=a[0],l=a[1];for(var s of l.entries()){var u=s[0],c=s[1];e[i].has(u)?n.ef[i].set(u,c):n.overpredicted[i].set(u,c)}}for(var d of r("objectEntries")(e)){var m=d[0],p=d[1];for(var _ of p.entries()){var f=_[0],g=_[1];t[m].has(f)||n.unpredicted[m].set(f,g)}}return n}function g(e){var t,n=e.efData,r=e.rsrcs,o=e.startTime,a=new Set,i,l,s;if(n){var u=f(r,n.tierOne);s=u.unpredicted,i={ef:_(u.ef,n.fetchRsrcsStart,d(),a),overpredicted:_(u.overpredicted,n.fetchRsrcsStart,d(),a)},l={ef_fetch_predictions:n.fetchPredictionsEnd-n.fetchPredictionsStart,ef_fetch_start_wait:n.fetchPredictionsEnd-n.fetchRsrcsStart,ef_head_start:o-n.fetchRsrcsStart}}else s=r,i={},l={};var c=babelHelpers.extends({unpredicted:_(s,o,d(),a)},i);return{source:e.source,source_detail:e.sourceDetail,is_first_identical:e.isFirstIdentical,timeslice_context:(t=e.timesliceContext)==null?void 0:t.name,start_time:o,err_count:a.size,resources:c,durations:babelHelpers.extends({jsmods_wait:e.jsmodsStart-o,jsmods:e.jsmodsEnd-e.jsmodsStart,jsmods_done_wait:e.jsmodsEnd-o,download_done_wait:e.logTime-o},l),payloadStats:e.payloadStats}}function h(e){var t,n=e.startTime,a=0,i=0,l=0,s=0;for(var u of e.components){var p=r("Bootloader").getComponentTiming(u),f=p.tierThreeEnd,g=p.tierThreeStart,h=p.tierTwoEnd,y=p.tierTwoStart;a=Math.max(a,c(n,y,h)),i=Math.max(i,c(n,n,h)),l=Math.max(l,c(n,g,f)),s=Math.max(s,c(n,n,f))}var C=new Set,b=d(),v=_(e.tierOne,n,b,C),S=_(e.tierTwo,n,b,C),R=_(e.tierThree,n,b,C),L=b.blocking.downloaded_count!=0,E=d(),k=o("BootloaderEvents").newResourceMapSet(),I=new Set;for(var T of[e.tierOne,e.tierTwo,e.tierThree])for(var D of r("objectValues")(T))for(var x of D.keys())I.add(x);var $=0,P=0,N=0;for(var M of e.beRequests.values()){$+=c(n,n,M.requestStart),P+=M.serverGenTime,N+=M.jsmodsEnd-M.jsmodsStart,m(E[L?"blocking":"nonblocking"],M.responseStart-M.requestStart,[M.uri,!1]);for(var w of r("objectEntries")(M.rsrcs)){var A=w[0],F=w[1];for(var O of F){var B=O[0],W=O[1];I.has(B)||k[A].set(B,W)}}}var q=_(k,n,b,C);return{ref:e.ref,components:e.components,timeslice_context:(t=e.timesliceContext)==null?void 0:t.name,start_time:n,err_count:C.size,resources:{t1:v,t2:S,t3:R,be:E,unpredicted:q,async:b},durations:{fetch_start_wait:e.fetchStartTime-n,be_start_wait:$,be_server_gen:P,be_jsmods:N,callback_wait:e.callbackStart-n,callback:e.callbackEnd-e.callbackStart,bootload_done_wait:e.callbackEnd-n,rdfd_requirelazy:a,rdfd_done_wait:i,rd_requirelazy:l,rd_done_wait:s}}}function y(t){var n=t.durations,o=t.resources,a=t.start_time,i=babelHelpers.objectWithoutPropertiesLoose(t,e);for(var l of r("objectEntries")(o)){var s=l[0],u=l[1];for(var c of r("objectEntries")(u)){var d=c[0],m=c[1];for(var p of r("objectEntries")(m)){var _=p[0],f=p[1];i[s+"_"+d+"_resources_"+_]=Math.round(Number(f))}}}for(var g of r("objectEntries")(n)){var h=g[0],y=g[1];i[h+"_duration"]=Math.round(Number(y))}if(i.payloadStats){for(var C of r("objectEntries")(i.payloadStats)){var b=C[0],v=C[1];for(var S of r("objectEntries")(v)){var R=S[0],L=S[1];i[b+"_"+R+"_count"]=Math.round(Number(L))}}delete i.payloadStats}return i}l.computeHRData=g,l.computeBLData=h,l.flattenData=y}),98);
__d("BootloaderErrorLoggerUtil",["BootloaderErrorsFalcoEvent","BootloaderEvents","BootloaderEventsPerf","ResourceTimingStore","ScriptPath","SiteData","performanceNavigationStart"],(function(t,n,r,o,a,i){var e=!1,l={initLogging:function(r){var t=r.parent_lid;if(!e){e=!0,n("ResourceTimingStore").init();var o=function(r){return{ms_since_navstart:Math.round(r-n("performanceNavigationStart")()),parent_lid:t,pkg_cohort:n("SiteData").pkg_cohort,request_path:n("ScriptPath").getScriptPath(),ef_page:n("ScriptPath").getEarlyFlushPage(),svn_rev:n("SiteData").client_revision}};n("BootloaderEvents").onBootloadError(function(e){return n("BootloaderErrorsFalcoEvent").log(function(){var t=n("BootloaderEventsPerf").computeBLData(e.bootloaderData),r=n("BootloaderEventsPerf").flattenData(t),a=babelHelpers.extends({},r,o(t.start_time),{status:"ERROR",was_offline:e.offline});return e.erroredResources!=null&&(a.errored_resource_urls=Array.from(e.erroredResources)),a})})}}};a.exports=l}),null);
__d("BootloaderLoggingStatusEnum",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum").Mirrored(["SUCCESS","TIMEOUT","ERROR"]),l=e;i.default=l}),66);
__d("CometBootloaderErrorsFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("1109"),s=o("FalcoLoggerInternal").create("comet_bootloader_errors",e),u=s;l.default=u}),98);
__d("CometBootloaderErrorLoggerUtil",["BootloaderEvents","BootloaderEventsPerf","CometBootloaderErrorsFalcoEvent","CometTimeSpentNavigation","ResourceTimingStore","SiteData","performanceNavigationStart"],(function(t,n,r,o,a,i,l){"use strict";var e=!1;function s(t){var n=t.parent_lid;e=!0,o("ResourceTimingStore").init();var a=function(t){var e;return{ms_since_navstart:Math.round(t-r("performanceNavigationStart")()),parent_lid:n,pkg_cohort:r("SiteData").pkg_cohort,request_path:(e=r("CometTimeSpentNavigation").getPathInfo())==null?void 0:e.name,svn_rev:r("SiteData").client_revision}},i=function(t,n){var e=o("BootloaderEventsPerf").computeBLData(t.bootloaderData),i=o("BootloaderEventsPerf").flattenData(e);r("CometBootloaderErrorsFalcoEvent").log(function(){var r=babelHelpers.extends({},i,a(e.start_time),{status:n,was_offline:t.offline});return t.erroredResources!=null&&(r.errored_resource_urls=Array.from(t.erroredResources)),r})};o("BootloaderEvents").onBootloadError(function(e){i(e,"ERROR")})}l.initLogging=s}),98);
__d("CometBootloaderEventsFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("177"),s=o("FalcoLoggerInternal").create("comet_bootloader_events",e),u=s;l.default=u}),98);
__d("HasteResponseFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("1823926"),s=o("FalcoLoggerInternal").create("haste_response",e),u=s;l.default=u}),98);
__d("CometBootloaderLoggerUtil",["BootloaderEvents","BootloaderEventsPerf","CometBootloaderEventsFalcoEvent","CometTimeSpentNavigation","HasteResponseFalcoEvent","ResourceTimingStore","SiteData","UserTimingUtils","gkx","performance","performanceNavigationStart"],(function(t,n,r,o,a,i,l){"use strict";var e,s=!1,u=r("gkx")("20483");function c(t){var n=t.bl_sample_rate,a=t.hr_sample_rate,i=t.parent_lid;if(!(s||!(n||a||u===!0))){s=!0,o("ResourceTimingStore").init();var l=function(t){var e;return{ms_since_navstart:Math.round(t-r("performanceNavigationStart")()),parent_lid:i,pkg_cohort:r("SiteData").pkg_cohort,request_path:(e=r("CometTimeSpentNavigation").getPathInfo())==null?void 0:e.name,svn_rev:r("SiteData").client_revision}};a&&o("BootloaderEvents").onHasteResponse(function(e){return r("HasteResponseFalcoEvent").log(function(){var t=o("BootloaderEventsPerf").computeHRData(e),n=o("BootloaderEventsPerf").flattenData(t);return babelHelpers.extends({},n,l(t.start_time))})}),u&&(o("BootloaderEvents").onBootload(function(t){o("UserTimingUtils").measureModern("Bootloader: "+t.components.join(", "),{end:t.callbackEnd-(e||(e=r("performance"))).timeOrigin,start:t.startTime-e.timeOrigin},"Bootloader Events")}),o("BootloaderEvents").onHasteResponse(function(t){o("UserTimingUtils").measureModern("Haste: "+t.source,{end:t.jsmodsEnd-(e||(e=r("performance"))).timeOrigin,properties:[["Source Detail",t.sourceDetail]],start:t.startTime-e.timeOrigin},"Bootloader Events")}));var c=function(t,n){var e=o("BootloaderEventsPerf").computeBLData(t),a=o("BootloaderEventsPerf").flattenData(e);r("CometBootloaderEventsFalcoEvent").log(function(){return babelHelpers.extends({},a,l(e.start_time),{status:n})})};n&&o("BootloaderEvents").onBootload(function(e){return c(e,"SUCCESS")}),o("BootloaderEvents").onBootloaderCallbackTimeout(function(e){return c(e,"TIMEOUT")})}}l.initLogging=c}),98);
__d("PromiseResult",["Promise"],(function(t,n,r,o,a,i){"use strict";var e,l=(function(){function t(){var t=this;this.promise=new(e||(e=n("Promise")))(function(e,n){t.$1=e,t.$2=n})}var r=t.prototype;return r.resolve=function(t){this.$1(t)},r.reject=function(t){this.$2(t)},t})();i.default=l}),66);
__d("MqttFetchClient",["MqttEnv","MqttProtocolCodec","MqttUserName","MqttUtils","Promise","PromiseResult","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s="fetch_pull",u="fetch_pull_finish",c="fetch_",d=6e4,m="action",p="chunked",_="send",f="true",g=5,h=20,y=10,C=5e3,b=typeof window!="undefined"?window:self,v=(function(){function t(){this.$1="",this.$2=o("MqttEnv").Env.getLoggerInstance(),this.$3=0,this.$4="",this.$5=new(r("MqttUserName"))("",0,1,"",0,!0),this.$6=function(){},this.$7=function(e){},this.$8=function(){},this.$9=function(e){},this.$10=0,this.$11=0,this.$12=0,this.$13=0,this.$14="Ready",this.$15=[],this.$16=[],this.$17=null,this.$18=!1,this.$19=0}t.isSupported=function(){return typeof b.fetch=="function"};var a=t.prototype;return a.run=function(t,n,r,a,i,l,s,u){var e=this;this.$1=o("MqttUtils").endpointWithSessionId(t,n),this.$3=n,this.$4=r,this.$5=a,this.$6=i,this.$7=l,this.$8=s,this.$9=u,o("MqttEnv").Env.setTimeout(function(){return e.$20()},0)},a.isTopicSupported=function(t){return!0},a.publish=function(t,n){return this.$21(t,n)},a.publishBinary=function(t,n){return this.$21(t,n)},a.$21=function(o,a){if(this.$14!=="ReceivingData")return this.$2.bumpCounter(c+"publish."+o+".invalidstate"),(e||(e=n("Promise"))).reject("not connected");this.$2.bumpCounter(c+"publish."+o+".publish");var t=new(r("PromiseResult")),i={topic:o,payload:a,promiseResult:t};return this.$15.push(i),this.$22(),t.promise},a.abort=function(){this.$6=function(){},this.$7=function(e){},this.$8=function(){},this.$9=function(e){}},a.$23=function(t){var e=this;t.forEach(function(t){e.$2.bumpCounter(c+"publish."+t.topic+".resolved"),t.promiseResult.resolve()}),this.$12+=t.length},a.$24=function(t,n){var e=this;t.forEach(function(t){e.$2.bumpCounter(c+"publish."+t.topic+".rejected"),t.promiseResult.reject(n)})},a.$25=function(t,n,r,o){var e=t.map(function(e){return e.topic}).join(",");this.$2.debugTrace("FetchClient","Fetch publish request failed. Publishes:"+e+", retry:"+r),this.$2.bumpCounter(c+"publish_request_failed"),this.$14!=="ReceivingData"||r===g?(this.$24(t,o),this.$18=!1,this.$2.bumpCounter(c+"publish_request_failed_final"),this.$22()):this.$26(t,n,r+1)},a.$27=function(t,n,r,o){if(!o.ok){if(this.$2.bumpCounter(c+"publish_request_failed.http."+o.status),o.status===409&&(this.$19++,this.$19>=y)){this.$2.bumpCounter(c+"409_reset"),this.$28(new Error("Too many 409 errors"));return}this.$25(t,n,r,this.$29(o));return}this.$2.bumpCounter(c+"publish_request_success");var e=t.map(function(e){return e.topic}).join(",");this.$2.debugTrace("FetchClient","Fetch publish request success. Publishes:"+e+", retry:"+r),this.$23(t),this.$18=!1,this.$22()},a.$22=function(){if(this.$14==="ReceivingData"&&!this.$18&&!(this.$15.length===0&&this.$16.length===0)){this.$18=!0;var e=this.$15.slice(0,h);this.$15=this.$15.slice(h,this.$15.length),this.$17!=null&&o("MqttEnv").Env.clearTimeout(this.$17),this.$17=null;var t=this.$16.slice(0,h);this.$16=this.$16.slice(h,this.$16.length),this.$26(e,t,0)}},a.$26=function(t,n,r){var e=this,a=t.map(function(e){return e.topic}).join(",");this.$2.debugTrace("FetchClient","Fetch publish request sent. Publishes:"+a+", retry:"+r);var i=o("MqttUtils").endpointWithExtraParameter(this.$1,m,_),l=t.map(function(e){return{topic:e.topic,payload:e.payload,qos:0,messageId:o("MqttEnv").Env.random()}}),s=this.$5.gen(this.$3,[],l,n);this.$2.bumpCounter(c+"publish_request"),o("MqttUtils").promiseDoneWithTimeout(b.fetch(i,{method:"POST",mode:"cors",cache:"no-cache",credentials:"include",referrer:"no-referrer",body:s,keepalive:!1}),function(o){return e.$27(t,n,r,o)},function(o){return e.$25(t,n,r,o)},d)},a.$30=function(t){var e=t.message;this.$2.debugTrace("FetchClient","Fetch request failed with error:"+e),this.$9(e),this.$31(!1,e),this.$2.bumpCounter(c+"error"),this.$14="Error"},a.$32=function(t){var e=this;this.$2.debugTrace("FetchClient","Fetch response data received");var n=o("MqttProtocolCodec").decodeByteMessages(new Uint8Array(t)),r=n.messages,a=r.filter(function(e){return e.messageType===o("MqttProtocolCodec").MESSAGE_TYPE.PINGREQ}),i=r.filter(function(e){return e.messageType===o("MqttProtocolCodec").MESSAGE_TYPE.PUBLISH}).map(function(t){if(!(t instanceof o("MqttProtocolCodec").WireMessage.Publish))return{};var n=t;return n.qos===1&&n.messageIdentifier!=null&&(e.$16.push(n.messageIdentifier),e.$17==null&&(e.$17=o("MqttEnv").Env.setTimeout(function(){e.$22()},C))),{topic:n.topic,payload:n.payloadMessage,qos:n.qos}});for(var l of i){var s;this.$2.bumpCounter(c+"response_"+((s=l.topic)!=null?s:"void"))}i&&i.length>0&&(this.$13+=i.length,this.$7(i)),a&&a.length>0&&this.$33()},a.$33=function(){this.$2.debugTrace("FetchClient","Got server ping request"),this.$2.bumpCounter(c+"ping")},a.$28=function(t){this.$2.debugTrace("FetchClient","Fetch request ended: "+t.toString()),this.$2.bumpCounter(c+"done"),this.$34(t.message),this.$8(),this.$14="Done"},a.$35=function(t,n,a){var e=this;if(a!=null)try{this.$32(a)}catch(e){this.$28(r("getErrorSafe")(e)),this.$2.bumpCounter(c+"dataDecodeException");return}if(n){this.$28(new Error("EOF"));return}o("MqttUtils").promiseDone(t.read(),function(n){var r=n.done,o=n.value;return e.$35(t,r,o)},function(t){return e.$28(t)})},a.$36=function(t){if(!t.ok){this.$2.bumpCounter(c+"error.http."+t.status),this.$30(this.$29(t));return}var e=t.body;if(!e){this.$30(new Error("Empty body"));return}var n=e.getReader();this.$6(),this.$2.bumpCounter(c+"success"),this.$31(!0,null),this.$11=Date.now(),this.$14="ReceivingData",this.$2.debugTrace("FetchClient","Fetch request success"),this.$35(n,!1,null)},a.$34=function(t){this.$2.eventLogPullFinish({pullEventName:u,sessionID:this.$3,duration:Date.now()-this.$11,errorMessage:t,publishReceived:this.$13,publishSent:this.$12})},a.$31=function(t,n){this.$2.eventLogPull({pullEventName:s,sessionID:this.$3,status:t,duration:Date.now()-this.$10,hostname:this.$1,errorMessage:n})},a.$20=function(){var e=this;if(this.$14==="Ready"){this.$2.debugTrace("FetchClient","Sending fetch request"),this.$2.bumpCounter(c+"request"),this.$10=Date.now();var t=o("MqttUtils").endpointWithExtraParameter(this.$1,p,f);o("MqttUtils").promiseDoneWithTimeout(b.fetch(t,{method:"POST",mode:"cors",cache:"no-cache",credentials:"include",referrer:"no-referrer",body:this.$4,keepalive:!1}),function(t){return e.$36(t)},function(t){return e.$30(t)},d)}},a.$29=function(t){return new Error("Http error, status="+t.status)},t})();l.default=v}),98);
__d("MqttLongPollingClient",["MqttEnv","MqttProtocolCodec","MqttUserName","Promise","XHRRequest","getCrossOriginTransport","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=12e4,u="simple_pull",c="longpolling_",d=(function(){function t(){this.$3="",this.$4=0,this.$2=o("MqttEnv").Env.getLoggerInstance(),this.$1="Ready",this.$5="",this.$6=new(r("MqttUserName"))("",0,1,"",0,!0),this.$7=function(){},this.$8=function(e){},this.$9=function(){},this.$10=function(e){},this.$11=0,this.$12=null,this.$13=new Set(["/t_ms","/messenger_sync_get_diffs","/messenger_sync_create_queue","/webrtc","/rtc_multi"])}var a=t.prototype;return a.run=function(t,n,r,o,a,i,l,s){this.$3=t,this.$4=n,this.$5=r,this.$6=o,this.$7=a,this.$8=i,this.$9=l,this.$10=s,this.$14(this.$5)},a.isTopicSupported=function(t){return this.$13.has(t)},a.publish=function(r,o){return(e||(e=n("Promise"))).reject("not supported")},a.publishBinary=function(r,o){return(e||(e=n("Promise"))).reject("not supported")},a.abort=function(){this.$12!=null&&this.$12.abort("Disconnected")},a.$15=function(t,n){this.$1!==t&&(this.$1=t,t==="Error"&&n!=null&&this.$10(n),this.$2.debugTrace("LongPollingClient","_changeStatus : "+t))},a.$16=function(t){if(this.$1==="RequestSend"){if(!t){this.$17("EmptyResponse",null);return}this.$7(),this.$2.bumpCounter(c+"success"),this.$18(!0,null),this.$15("ResponseReceived");var e=o("MqttProtocolCodec").decodeByteMessages(new Uint8Array(t)),n=e.messages.filter(function(e){return e instanceof o("MqttProtocolCodec").WireMessage.Publish}).map(function(e){if(e instanceof o("MqttProtocolCodec").WireMessage.Publish){var t=e;return{topic:t.topic,payload:t.payloadMessage,qos:t.qos}}else return{}});this.$8(n),this.$9()}},a.$17=function(t,n){var e=n!=null?n.message:"null";this.$2.debugTrace("LongPollingClient Error","Poll failed with error:"+t+", errorMsg:"+e),this.$18(!1,t+":"+e),this.$2.bumpCounter(c+"error."+t),this.$15("Error",t)},a.$18=function(t,n){this.$2.eventLogPull({pullEventName:u,sessionID:this.$4,status:t,duration:Date.now()-this.$11,hostname:this.$3,errorMessage:n})},a.$14=function(t){var e=this;if(!(this.$1!=="Ready"||this.$12)){this.$2.bumpCounter(c+"request");try{this.$11=Date.now(),this.$12=new(r("XHRRequest"))(this.$3).setResponseType("arraybuffer").setRawData(t).setTransportBuilder(r("getCrossOriginTransport").withCredentials).setResponseHandler(function(t){return e.$16(t)}).setNetworkFailureHandler(function(t){e.$17("Network",t)}).setErrorHandler(function(t){e.$17("Error",t)}).setAbortHandler(function(t){e.$17("Abort",null)}).setTimeoutHandler(function(){e.$17("Timeout",null)}).setTimeout(s).send(),this.$15("RequestSend")}catch(e){this.$17("Error",r("getErrorSafe")(e))}}},t})();l.default=d}),98);
__d("MqttLongPollingHookCollection",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(){this.$1=new Set}var t=e.prototype;return t.addHook=function(t){this.$1.add(t)},t.removeHook=function(t){this.$1.delete(t)},t.onPollRequestSent=function(){this.$1.forEach(function(e){e.onPollRequestSent()})},t.onPollRequestSuccess=function(){this.$1.forEach(function(e){e.onPollRequestSuccess()})},t.onPollResponse=function(t){this.$1.forEach(function(e){e.onPollResponse(t)})},t.onPollFinish=function(){this.$1.forEach(function(e){e.onPollFinish()})},t.onPollRequestFailed=function(t){this.$1.forEach(function(e){e.onPollRequestFailed(t)})},t.onPollShutdownAbort=function(){this.$1.forEach(function(e){e.onPollShutdownAbort()})},e})();i.default=e}),66);
__d("exponentialBackoff",["MqttEnv"],(function(t,n,r,o,a,i,l){function e(e,t){t===void 0&&(t=null);var n=null,r=0;function a(){for(var a=arguments.length,i=new Array(a),l=0;l<a;l++)i[l]=arguments[l];var s=function(){e.apply(t,i)};if(n===null){var u=Math.max(0,Math.pow(2,Math.min(r,6))*(1e3+o("MqttEnv").Env.random()*100)-2e3);n=o("MqttEnv").Env.setTimeout(function(){s(),n=null},u)}r++}return a.reset=function(){r=0,n!=null&&(o("MqttEnv").Env.clearTimeout(n),n=null)},a.isPending=function(){return n!=null},a}l.default=e}),98);
__d("MqttLongPollingRunner",["MqttEnv","MqttFetchClient","MqttLongPollingClient","MqttLongPollingHookCollection","MqttTypes","MqttUtils","MqttWebSocketUtils","Promise","exponentialBackoff","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=4,u=1e3,c=3e3,d="mqtt_should_longpoll",m="last_lp",p="yes",_="no",f=(function(){function t(e,t,n,a,i,l,s,u,c){var d=this;this.$23=function(){try{if(!d.$30())return;d.$5.debugTrace("LongPollingRunner","_startPollingIfNecessary called");var e=d.$31();d.$14=e;var t=d.$9(),n=d.$10(),a=t.filter(function(t){return e.isTopicSupported(t)}),i=n.filter(function(t){return e.isTopicSupported(t.topic)});if(a.length===0&&i.length===0){d.$5.debugTrace("LongPollingRunner","Poll skipped, nothing to do"),d.$14=null,o("MqttEnv").Env.setTimeout(function(){d.$23()},1e3);return}var l=o("MqttUtils").generateSessionId();e.run(d.$6,l,d.$7.gen(l,a,i),d.$7,function(){return d.$32()},function(e){return d.$33(e)},function(){return d.$34()},function(e){return d.$35(e)}),d.$19.onPollRequestSent();var s=a.join(","),u=i.map(function(e){return e.topic}).join(",");d.$5.debugTrace("LongPollingRunner","Making a poll request to "+d.$6+". SubscribedTopics:"+s+". Publishes:"+u)}catch(e){var c=r("getErrorSafe")(e);d.$5.logErrorWarn(c,"lp_js_error"),d.$11(new(o("MqttTypes")).MqttChannelError(!1,"js error lp",c)),d.$35("lp_js_error")}},this.$6=e,this.$7=t,this.$1=a,this.$2=0,this.$3=n,this.$4=o("MqttWebSocketUtils").hasWSSupport(),this.$5=o("MqttEnv").Env.getLoggerInstance(),this.$8=i,this.$9=l,this.$10=s,this.$11=u,this.$12=c,this.$13=!1,this.$14=null,this.$15="LPInactive",this.$16="NotSent",this.$17=0,this.$19=new(r("MqttLongPollingHookCollection")),this.$18=r("exponentialBackoff")(this.$23,this),this.$20=0,this.$21=_;var m=o("MqttEnv").Env.genGk(o("MqttEnv").MqttGkNames.mqtt_lp_use_fetch),p=r("MqttFetchClient").isSupported();m?this.$5.bumpCounter("fetch_gk_pass"):this.$5.bumpCounter("fetch_gk_fail"),p?this.$5.bumpCounter("fetch_api_supported"):this.$5.bumpCounter("fetch_api_not_supported"),this.$22=m&&p}var a=t.prototype;return a.addHook=function(t){this.$19.addHook(t)},a.start=function(){var e=this;this.$21=o("MqttEnv").Env.configRead(m,_),this.$5.debugTrace("LongPollingRunner","Runner loaded, last status "+this.$21),this.$20=Date.now(),this.$23(),o("MqttEnv").Env.setTimeout(function(){e.$23()},u+100),o("MqttEnv").Env.setTimeout(function(){e.$23()},c+100)},a.shutdown=function(){this.$5.debugTrace("LongPollingRunner","Shutdown called"),this.$14&&this.$14.abort(),this.$19.onPollShutdownAbort(),this.$14=null},a.canPublish=function(){return this.$15==="LPActive"&&this.$16==="ReceivingData"},a.publish=function(t,n,r){return this.$24(t,n)},a.publishBinary=function(t,n,r){return this.$24(t,n)},a.$24=function(r,a){return o("MqttEnv").Env.genGk(o("MqttEnv").MqttGkNames.mqtt_enable_publish_over_polling)&&this.$14&&this.$14.isTopicSupported(r)?typeof a=="string"?this.$14.publish(r,a):this.$14.publishBinary(r,a):(e||(e=n("Promise"))).reject()},a.onConnectAttempt=function(){},a.onConnectFailure=function(){this.$2++,this.$23()},a.onConnected=function(){},a.onConnectSuccess=function(){this.$1=!0,o("MqttEnv").Env.configWrite(m,null)},a.onConnectionLost=function(){},a.onConnectionDisconnect=function(){},a.onSubscribe=function(t){},a.onUnsubscribe=function(t){},a.onPublish=function(t){},a.onMessage=function(t){},a.onWSFatal=function(){this.$3=!0,this.$23()},a.getStatus=function(){return this.$15},a.getRequestStatus=function(){return this.$16},a.$25=function(t){t!==this.$15&&(this.$5.debugTrace("LongPollingRunner","status changed to "+t+" from "+this.$15),this.$15=t,this.$12(this.$15,this.$16))},a.$26=function(t){this.$22&&t!==this.$16&&(this.$5.debugTrace("LongPollingRunner","request status changed to "+t+" from "+this.$16),this.$16=t,this.$12(this.$15,this.$16))},a.$27=function(){this.$17=0},a.$28=function(){this.$17++,this.$17>=s&&this.$25("LPError")},a.$29=function(){var e,t=(e=o("MqttEnv")).Env.genGk(e.MqttGkNames.mqtt_lp_no_delay),n=e.Env.genGk(e.MqttGkNames.mqtt_ws_polling_enabled),r=e.Env.genGk(e.MqttGkNames.mqtt_fast_lp);if(this.$5.debugTrace("LongPollingRunner","_shouldPoll? pollNow:"+String(t)+" enabled:"+String(n)+" fastPoll:"+String(r)+" hasWSSupport:"+String(this.$4)+" hasWsSuccessBefore:"+String(this.$1)+" failureCount:"+this.$2+" wsFatal:"+String(this.$3)),!n)return!1;if(t)return this.$5.bumpCounter(d+".nd"),!0;if(!this.$4)return this.$5.bumpCounter(d+".na"),!0;if(this.$3)return this.$5.bumpCounter(d+".fatal"),!0;if(this.$1)return!1;if(r){var a=Date.now()-this.$20;if(this.$21===p){if(this.$2>=1)return!0;if(a>u)return this.$5.bumpCounter(d+".fastdelay"),!0}else if(a>c)return this.$5.bumpCounter(d+".regulardelay"),!0}return this.$2>=3?(this.$5.bumpCounter(d+".failure"),!0):!1},a.$30=function(){if(this.$14!=null)return!1;var e=this.$29();return!this.$13&&e&&(this.$5.bumpCounter("polling_kickin"),this.$13=!0,this.$25("LPActive"),this.$27()),this.$13&&!e&&(this.$5.bumpCounter("polling_stopped"),this.$13=!1,this.$25("LPInactive"),this.$27()),e},a.$31=function(){return this.$22?(this.$5.debugTrace("LongPollingRunner","Creating polling client using Fetch API"),new(r("MqttFetchClient"))):(this.$5.debugTrace("LongPollingRunner","Creating regular Polling client"),new(r("MqttLongPollingClient")))},a.$32=function(){this.$5.debugTrace("LongPollingRunner","Poll success"),this.$19.onPollRequestSuccess(),this.$18.reset(),this.$25("LPActive"),this.$27(),o("MqttEnv").Env.configWrite(m,p),this.$26("ReceivingData")},a.$33=function(t){var e=t.map(function(e){return e.topic}).join(",");this.$5.debugTrace("LongPollingRunner","Poll response received, message received:"+e);for(var n of t)this.$19.onPollResponse(n.topic),this.$8(n.topic,n.payload,n.qos)},a.$34=function(){this.$5.debugTrace("LongPollingRunner","Poll finish"),this.$19.onPollFinish(),this.$14&&this.$14.abort(),this.$14=null,this.$23(),this.$26("NotSent")},a.$35=function(t){this.$19.onPollRequestFailed(t),this.$14&&this.$14.abort(),this.$14=null,this.$18(),this.$28(),this.$26("NotSent")},t})();l.default=f}),98);
__d("WebWorkerInitDeferred",["BootloaderErrorLoggerUtil","CometBootloaderErrorLoggerUtil","cr:7429"],(function(t,n,r,o,a,i,l){"use strict";function e(e){e.blLoggingCavalryFields&&(n("cr:7429").initLogging(e.blLoggingCavalryFields),o("CometBootloaderErrorLoggerUtil").initLogging(e.blLoggingCavalryFields),o("BootloaderErrorLoggerUtil").initLogging(e.blLoggingCavalryFields))}l.initDeferred=e}),98);